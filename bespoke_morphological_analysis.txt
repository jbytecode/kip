This file lists the locations of bespoke morphological analysis found in the Kip codebase. The goal is to eventually replace this logic with calls to the `TRmorph` FSM via the functions provided in `src/Language/Foma.hs`.

The primary location for this bespoke logic is `src/Kip/Render.hs`. This file contains rendering utilities that, in addition to using the Foma FSM, implement their own fallback rules for Turkish morphology.

Here is a list of functions and sections in `src/Kip/Render.hs` that contain bespoke morphological analysis:

### 1. Fallback Inflection
These functions are used when the main morphology engine (`TRmorph`) fails to produce a result. They manually append suffixes based on simple vowel harmony rules.

- `fallbackInflect`: The main entry point for fallback inflection.
- `addGenSuffix`: Manually adds the genitive suffix (e.g., "-in", "-nin").
- `addAccSuffix`: Manually adds the accusative suffix (e.g., "-i", "-yi").
- `addDatSuffix`: Manually adds the dative suffix (e.g., "-e", "-ye").
- `addLocSuffix`: Manually adds the locative suffix (e.g., "-de", "-da").
- `addAblSuffix`: Manually adds the ablative suffix (e.g., "-den", "-dan").
- `addP3sSuffix`: Manually adds the 3rd person possessive suffix (e.g., "-i", "-si").

**Example Snippet (`addGenSuffix`):**
```haskell
-- | Add the genitive suffix for a simple fallback inflection.
addGenSuffix :: String -- ^ Surface form.
             -> String -- ^ Inflected form.
addGenSuffix s
  | null s = s
  | maybe False isDigit (lastChar s) = s ++ "'nin"
  | otherwise =
      case lastVowel s of
        Nothing -> s ++ "in"
        Just v ->
          let suffixV = genVowel v
              connector = if endsWithVowel s then "n" else ""
          in s ++ connector ++ [suffixV] ++ "n"
  where
    genVowel v
      | v `elem` "aı" = 'ı'
      | v `elem` "ou" = 'u'
      | v `elem` "ei" = 'i'
      | v `elem` "öü" = 'ü'
      | otherwise = 'i'
```

### 2. Vowel and Consonant Helpers
These functions provide the basic building blocks for the manual suffix rules.

- `lastVowel`: Finds the last vowel in a word.
- `endsWithVowel`: Checks if a word ends with a vowel.
- `isVowel`: A predicate to identify Turkish vowels.
- `isConsonant`: A predicate to identify consonants.
- `p3sVowel`: Selects a vowel for the possessive suffix based on the last vowel of the stem.

### 3. Gerund Formation
These functions manually create the gerund form of a verb.

- `fallbackGerund`: Appends "-mek" or "-mak" based on vowel harmony.
- `isFrontVowel`: A helper to determine which gerund suffix to use.

**Example Snippet (`fallbackGerund`):**
```haskell
-- | Fallback gerund formation without morphology.
fallbackGerund :: String -- ^ Base verb stem.
               -> String -- ^ Gerund form.
fallbackGerund base =
  base ++ if isFrontVowel (lastVowel base) then "mek" else "mak"
```

### 4. Heuristics for Selecting and Cleaning Forms
This code attempts to "clean up" or choose the "best" result from the morphological analyzer, which can be considered a form of manual analysis.

- `pickDownFormWithStem`: Prefers certain forms based on heuristics, such as avoiding doubled consonants.
- `doesNotDoubleConsonant`: A heuristic to prevent selecting forms where the final consonant of the stem is doubled.
- `hasDoubledConsonant`: The implementation of the consonant doubling check.

### 5. Manual Case Application
- `applyCaseToLastWord`: Finds the last word in a string and manually applies a case inflection to it, again using the bespoke rendering functions.

All of these functions represent morphological logic that is being handled by hand in Haskell, rather than being delegated to the `TRmorph` FSM.

### Problems with Bespoke Methods

The current fallback implementation is based on simple suffix concatenation and vowel harmony rules. Turkish morphology has many complexities that this approach fails to handle, leading to incorrect word forms.

Here are some examples of where the bespoke methods can fail:

1.  **Consonant Voicing (p-ç-t-k softening):** The code does not handle the voicing of final consonants when a vowel-initial suffix is added.
    *   **Word:** `kitap` (book)
    *   **Case:** Accusative
    *   **Bespoke Method:** `kitapı`
    *   **Correct Form:** `kitabı` (p -> b)
    *   **Word:** `ağaç` (tree)
    *   **Case:** Dative
    *   **Bespoke Method:** `ağaca`
    *   **Correct Form:** `ağaca` (ç -> c). The bespoke method gets this right by luck, but not the root cause. `ağaçı` would be `ağacı`.

2.  **Vowel Dropping (Syncope):** In many two-syllable words, the vowel in the second syllable is dropped when a suffix is added.
    *   **Word:** `şehir` (city)
    *   **Case:** Genitive
    *   **Bespoke Method:** `şehirin`
    *   **Correct Form:** `şehrin`
    *   **Word:** `oğul` (son)
    *   **Case:** P3s (his son)
    *   **Bespoke Method:** `oğulu`
    *   **Correct Form:** `oğlu`

3.  **Irregular Forms and Loanwords:** Many words, especially loanwords, do not follow standard vowel harmony.
    *   **Word:** `saat` (hour/clock)
    *   **Case:** Locative
    *   **Bespoke Method:** `saatda` (follows back-vowel harmony)
    *   **Correct Form:** `saatte` (violates standard harmony)
    *   **Word:** `alkol` (alcohol)
    *   **Case:** Accusative
    *   **Bespoke Method:** `alkolı`
    *   **Correct Form:** `alkolü`

4.  **The "su" (water) exception:** The word `su` is famously irregular.
    *   **Word:** `su` (water)
    *   **Case:** Accusative
    *   **Bespoke Method:** `suyı` (from `addAccSuffix`)
    *   **Correct Form:** `suyu`

5.  **Proper Nouns:** The bespoke logic does not properly distinguish nouns to add an apostrophe.
    *   **Word:** `Ankara`
    *   **Case:** Dative
    *   **Bespoke Method:** `Ankaraya`
    *   **Correct Form:** `Ankara'ya`

### Plan for Replacement

The goal is to eliminate the fallback functions and rely solely on `TRmorph` for morphological generation. This will improve correctness and centralize the linguistic logic within the FSM.

1.  **Adopt an "Analyze, Modify, Generate" Pattern:**
    Instead of assuming a given word is a valid stem, the system should first analyze it to find its true lemma and morphological tags.
    *   Call `ups` (or `upsCached`) on the input word (e.g., "kitap").
    *   This will return one or more analyses (e.g., `kitap<N><A3sg><Nom>`).
    *   Modify this analysis string to the desired new form. For example, to get the dative, replace `<Nom>` with `<Dat>` to get `kitap<N><A3sg><Dat>`.
    *   Call `downs` (or `downsCached`) on the new analysis string (`kitap<N><A3sg><Dat>`) to get the correctly inflected surface form (`kitaba`).
    This approach, already hinted at in `deriveInflectedForms`, correctly handles consonant voicing and other complex phenomena that `TRmorph` knows about.

2.  **Refactor `renderIdentWithCases`:**
    This function should be the primary entry point for inflection. It should be modified to strictly follow the "Analyze, Modify, Generate" pattern described above. The direct call to `fallbackInflect` should be removed.

3.  **Implement a Smarter Fallback Strategy:**
    When `downs` returns an empty list, it means `TRmorph` failed. Instead of the current `fallbackInflect`, a more robust strategy should be used:
    *   **Log Failures:** Every time `ups` or `downs` fails for a given word, log it. This creates a valuable data set for identifying words missing from the `TRmorph` lexicon and improving it over time.
    *   **Return Uninflected:** As a last resort, the system should simply return the uninflected base word. Appending an incorrect suffix is often worse than not inflecting at all, as it produces a non-existent word.
    *   **Consider Apostrophe Suffixation for Unknowns:** A potential improvement could be to mimic human language use for unknown words or proper nouns by appending suffixes with an apostrophe (e.g., `Google'a`). This is a visual cue that the root word is unanalyzed.

4.  **Remove Redundant Code:**
    Once the new system is in place, the following functions and helpers can be removed entirely:
    *   All `add...Suffix` functions.
    *   `fallbackInflect` and `fallbackGerund`.
    *   The vowel and consonant helpers (`lastVowel`, `isVowel`, etc.) unless they are used elsewhere for non-morphological reasons.
    *   The heuristics in `pickDownFormWithStem` (like `doesNotDoubleConsonant`) should be re-evaluated. They may no longer be necessary if `TRmorph` provides the correct forms directly.

By implementing this plan, the code will become simpler, more correct, and easier to maintain, as the complex linguistic rules will be managed entirely by the `TRmorph` FSM.
